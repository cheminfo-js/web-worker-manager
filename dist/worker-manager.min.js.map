{"version":3,"sources":["worker-manager.min.js"],"names":["e","exports","module","define","amd","f","window","global","self","WorkerManager","t","n","r","s","o","u","a","require","i","Error","code","l","call","length",1,"noop","func","options","TypeError","undefined","this","_workerCode","toString","_numWorkers","maxWorkers","Math","min","CORES","_workers","Array","_timeout","timeout","_terminateOnError","terminateOnError","deps","_terminated","_working","_waiting","_init","workerTemplate","navigator","hardwareConcurrency","prototype","workerURL","newWorkerURL","worker","Worker","postMessage","action","id","onmessage","_onmessage","bind","onerror","_onerror","running","URL","revokeObjectURL","error","currentCallback","terminate","_exec","event","data","execInfo","shift","args","time","Date","now","postAll","post","callback","push","./workerTemplate",2,"ManagedWorker","_id","_listeners","on","RangeError","send","trigger","apply","importScripts","workerStr","split","blob","Blob","type","createObjectURL"],"mappings":"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","file":"worker-manager.min.js","sourcesContent":["/**\n * worker-manager - Worker manager\n * @version v0.0.1\n * @link https://github.com/cheminfo-js/worker-manager\n * @license MIT\n */\n!function(e){if(\"object\"==typeof exports&&\"undefined\"!=typeof module)module.exports=e();else if(\"function\"==typeof define&&define.amd)define([],e);else{var f;\"undefined\"!=typeof window?f=window:\"undefined\"!=typeof global?f=global:\"undefined\"!=typeof self&&(f=self),f.WorkerManager=e()}}(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n'use strict';\n\nvar workerTemplate = require('./workerTemplate');\n\nvar CORES = navigator.hardwareConcurrency || 1;\n\nfunction noop() {\n}\n\nfunction WorkerManager(func, options) {\n\n    // Check arguments\n    if (typeof func !== 'function')\n        throw new TypeError('func argument must be a function');\n    if (options === undefined)\n        options = {};\n    if (typeof options !== 'object' || options === null)\n        throw new TypeError('options argument must be an object');\n\n    this._workerCode = func.toString();\n\n    // Parse options\n    this._numWorkers = (options.maxWorkers > 0) ? Math.min(options.maxWorkers, CORES) : CORES;\n    this._workers = new Array(this._numWorkers);\n    this._timeout = options.timeout || 0;\n    this._terminateOnError = !!options.terminateOnError;\n\n    var deps = options.deps;\n    if (typeof deps === 'string')\n        deps = [deps];\n\n    this._terminated = false;\n    this._working = 0;\n    this._waiting = [];\n\n    this._init(deps);\n\n}\n\nWorkerManager.prototype._init = function (deps) {\n\n    var workerURL = workerTemplate.newWorkerURL(this._workerCode);\n\n    for (var i = 0; i < this._numWorkers; i++) {\n        var worker = new Worker(workerURL);\n        worker.postMessage({\n            action: 'init',\n            id: i,\n            deps: deps\n        });\n        worker.onmessage = this._onmessage.bind(this, worker);\n        worker.onerror = this._onerror.bind(this, worker);\n        worker.running = false;\n        this._workers[i] = worker;\n    }\n\n    URL.revokeObjectURL(workerURL);\n\n};\n\nWorkerManager.prototype._onerror = function (worker, error) {\n    if (this._terminated)\n        return;\n    this._working--;\n    worker.currentCallback(error);\n    worker.running = false;\n    if (this._terminateOnError) {\n        this.terminate();\n    } else {\n        this._exec();\n    }\n};\n\nWorkerManager.prototype._onmessage = function (worker, event) {\n    if (this._terminated)\n        return;\n    this._working--;\n    worker.currentCallback(null, event.data);\n    worker.running = false;\n    this._exec();\n};\n\nWorkerManager.prototype._exec = function () {\n    if (this._working === this._numWorkers || this._waiting.length === 0)\n        return;\n    for (var i = 0; i < this._numWorkers; i++) {\n        if (!this._workers[i].running) {\n            var execInfo = this._waiting.shift();\n            var worker = this._workers[i];\n            worker.postMessage({\n                action: 'exec',\n                event: execInfo[0],\n                args: execInfo[1]\n            });\n            worker.running = true;\n            worker.time = Date.now();\n            worker.currentCallback = execInfo[2] || noop;\n            this._working++;\n            break;\n        }\n    }\n};\n\nWorkerManager.prototype.terminate = function () {\n    if (this._terminated)\n        return;\n    for (var i = 0; i < this._numWorkers; i++) {\n        this._workers[i].terminate();\n    }\n    this._terminated = true;\n};\n\nWorkerManager.prototype.postAll = function (event, args) {\n    if (this._terminated)\n        throw new Error('Cannot post (terminated)');\n    for (var i = 0; i < this._numWorkers; i++) {\n        this._workers[i].postMessage({\n            action: 'exec',\n            event: event,\n            args: args\n        });\n    }\n};\n\nWorkerManager.prototype.post = function (event, args, callback) {\n    if (this._terminated)\n        throw new Error('Cannot post (terminated)');\n    this._waiting.push([event, args, callback]);\n    this._exec();\n};\n\nmodule.exports = WorkerManager;\n\n},{\"./workerTemplate\":2}],2:[function(require,module,exports){\n'use strict';\n\nvar worker = function () {\n    self.window = self;\n    function ManagedWorker() {\n        this._id = -1;\n        this._listeners = {};\n    }\n    ManagedWorker.prototype.on = function (event, callback) {\n        if (this._listeners[event])\n            throw new RangeError('there is already a listener for ' + event);\n        if (typeof callback !== 'function')\n            throw new TypeError('callback argument must be a function');\n        this._listeners[event] = callback;\n    };\n    ManagedWorker.prototype.send = function (data) {\n        self.postMessage(data);\n    };\n    ManagedWorker.prototype.trigger = function (event, args) {\n        if (!this._listeners[event])\n            throw new Error('event ' + event + ' is not defined');\n        this._listeners[event].apply(null, args);\n    };\n    var worker = new ManagedWorker();\n    self.onmessage = function (event) {\n        switch(event.data.action) {\n            case 'init':\n                worker._id = event.data.id;\n                if (event.data.deps) {\n                    importScripts.apply(self, event.data.deps);\n                }\n                break;\n            case 'exec':\n                worker.trigger(event.data.event, event.data.args);\n                break;\n            case 'ping':\n                worker.send('pong');\n                break;\n        }\n    };\n    ((\"CODE\"))\n};\n\nvar workerStr = worker.toString().split('((\"CODE\"))');\n\nexports.newWorkerURL = function newWorkerURL(code) {\n    var blob = new Blob(['(', workerStr[0], '(', code, ')();', workerStr[1], ')();'], {type: 'application/javascript'});\n    return URL.createObjectURL(blob);\n};\n\n},{}]},{},[1])(1)\n});"],"sourceRoot":"/source/"}